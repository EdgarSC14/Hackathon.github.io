<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pruebas de Contrato Stylus - Impulso Web3</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
</head>
<body class="bg-gray-900 text-white p-8">
    <div class="container mx-auto max-w-4xl">
        <h1 class="text-4xl font-bold mb-6 text-purple-400">
            <i class="fas fa-flask mr-3"></i>Pruebas de Contrato Stylus
        </h1>

        <!-- Estado de conexión -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">Estado de Conexión</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <div class="text-sm text-gray-400">Red</div>
                    <div id="currentNetwork" class="font-bold text-purple-400">No conectado</div>
                </div>
                <div>
                    <div class="text-sm text-gray-400">Wallet</div>
                    <div id="walletAddress" class="font-mono text-sm">No conectada</div>
                </div>
                <div>
                    <button id="connectBtn" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded">
                        Conectar Wallet
                    </button>
                </div>
            </div>
        </div>

        <!-- Información del Contrato -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">Información del Contrato</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Dirección del Contrato</label>
                    <input type="text" id="contractAddress" class="w-full bg-gray-700 text-white px-4 py-2 rounded font-mono text-sm" 
                           placeholder="0x..." value="0x1234567890123456789012345678901234567890">
                </div>
                <div>
                    <button id="loadContractBtn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded mt-7">
                        Cargar Contrato
                    </button>
                </div>
            </div>
            <div id="contractInfo" class="mt-4 hidden">
                <div class="bg-green-600/20 rounded p-4 border border-green-500/30">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-check-circle text-green-400"></i>
                        <span class="font-bold">Contrato cargado correctamente</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pruebas de Funciones -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">Pruebas de Funciones</h2>

            <!-- getBalance -->
            <div class="mb-6 border-b border-gray-700 pb-6">
                <h3 class="text-xl font-bold mb-3 text-purple-400">1. getBalance(address)</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="text" id="balanceAddress" class="bg-gray-700 text-white px-4 py-2 rounded font-mono text-sm" 
                           placeholder="Dirección (0x...)" value="">
                    <button id="getBalanceBtn" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">
                        Consultar Balance
                    </button>
                    <div id="balanceResult" class="text-lg font-bold text-green-400">-</div>
                </div>
            </div>

            <!-- deposit -->
            <div class="mb-6 border-b border-gray-700 pb-6">
                <h3 class="text-xl font-bold mb-3 text-purple-400">2. deposit() - Depositar ETH</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="number" id="depositAmount" step="0.0001" min="0.0001" 
                           class="bg-gray-700 text-white px-4 py-2 rounded" placeholder="Monto (ETH)" value="0.001">
                    <button id="depositBtn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                        Depositar
                    </button>
                    <div id="depositResult" class="text-sm text-gray-400">Ingresa un monto y haz clic en Depositar</div>
                </div>
            </div>

            <!-- sendPayment -->
            <div class="mb-6 border-b border-gray-700 pb-6">
                <h3 class="text-xl font-bold mb-3 text-purple-400">3. sendPayment(address to, uint256 amount)</h3>
                <div class="space-y-3">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Dirección destino</label>
                            <input type="text" id="paymentTo" class="w-full bg-gray-700 text-white px-4 py-2 rounded font-mono text-sm" 
                                   placeholder="0x...">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Monto (ETH)</label>
                            <input type="number" id="paymentAmount" step="0.0001" min="0.0001" 
                                   class="w-full bg-gray-700 text-white px-4 py-2 rounded" placeholder="0.001" value="0.001">
                        </div>
                    </div>
                    <button id="sendPaymentBtn" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded w-full md:w-auto">
                        Enviar Pago
                    </button>
                    <div id="paymentResult" class="text-sm text-gray-400">Ingresa dirección y monto para enviar</div>
                </div>
            </div>

            <!-- withdraw -->
            <div class="mb-6">
                <h3 class="text-xl font-bold mb-3 text-purple-400">4. withdraw(uint256 amount)</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="number" id="withdrawAmount" step="0.0001" min="0.0001" 
                           class="bg-gray-700 text-white px-4 py-2 rounded" placeholder="Monto (ETH)" value="0.001">
                    <button id="withdrawBtn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded">
                        Retirar
                    </button>
                    <div id="withdrawResult" class="text-sm text-gray-400">Ingresa un monto para retirar</div>
                </div>
            </div>
        </div>

        <!-- Log de Transacciones -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-2xl font-bold mb-4">Log de Transacciones</h2>
            <div id="transactionLog" class="bg-gray-900 rounded p-4 max-h-64 overflow-y-auto font-mono text-xs">
                <div class="text-gray-500">Esperando transacciones...</div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="networks.js"></script>
    <script src="contracts-arbitrum.js"></script>
    <script src="stylus-contracts.js"></script>
    <script>
        let web3 = null;
        let userAddress = null;
        let contract = null;
        let contractAddress = null;

        // ABI del contrato Stylus
        const CONTRACT_ABI = [
            {
                "inputs": [{"internalType": "address", "name": "user", "type": "address"}],
                "name": "getBalance",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "deposit",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "address", "name": "to", "type": "address"},
                    {"internalType": "uint256", "name": "amount", "type": "uint256"}
                ],
                "name": "sendPayment",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "amount", "type": "uint256"}],
                "name": "withdraw",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        function log(message, type = 'info') {
            const logEl = document.getElementById('transactionLog');
            const time = new Date().toLocaleTimeString();
            const colors = {
                'info': 'text-blue-400',
                'success': 'text-green-400',
                'error': 'text-red-400',
                'warning': 'text-yellow-400'
            };
            const icon = {
                'info': 'ℹ️',
                'success': '✅',
                'error': '❌',
                'warning': '⚠️'
            };
            const entry = document.createElement('div');
            entry.className = `mb-2 ${colors[type]}`;
            entry.textContent = `[${time}] ${icon[type]} ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function connectWallet() {
            if (!window.ethereum) {
                alert('MetaMask no está instalado');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];
                web3 = new Web3(window.ethereum);
                
                const networkId = await web3.eth.net.getId();
                const networkName = NETWORKS.arbitrumSepolia.chainIdDec === networkId ? 'Arbitrum Sepolia' :
                                   NETWORKS.arbitrumOne.chainIdDec === networkId ? 'Arbitrum One' : 
                                   `Unknown (${networkId})`;

                document.getElementById('currentNetwork').textContent = networkName;
                document.getElementById('walletAddress').textContent = `${userAddress.substring(0, 6)}...${userAddress.substring(38)}`;
                document.getElementById('connectBtn').textContent = 'Conectado';
                document.getElementById('connectBtn').classList.add('bg-green-600', 'hover:bg-green-700');
                document.getElementById('connectBtn').classList.remove('bg-purple-600', 'hover:bg-purple-700');
                document.getElementById('balanceAddress').value = userAddress;

                log('Wallet conectada: ' + userAddress, 'success');
            } catch (error) {
                log('Error al conectar: ' + error.message, 'error');
            }
        }

        async function loadContract() {
            contractAddress = document.getElementById('contractAddress').value.trim();
            if (!contractAddress || !contractAddress.startsWith('0x') || contractAddress.length !== 42) {
                alert('Dirección de contrato inválida');
                return;
            }

            if (!web3) {
                alert('Conecta tu wallet primero');
                return;
            }

            try {
                contract = new web3.eth.Contract(CONTRACT_ABI, contractAddress);
                document.getElementById('contractInfo').classList.remove('hidden');
                log(`Contrato cargado: ${contractAddress}`, 'success');
            } catch (error) {
                log('Error al cargar contrato: ' + error.message, 'error');
            }
        }

        async function testGetBalance() {
            if (!contract) {
                alert('Carga el contrato primero');
                return;
            }

            const address = document.getElementById('balanceAddress').value.trim();
            if (!address || !address.startsWith('0x')) {
                alert('Dirección inválida');
                return;
            }

            try {
                log(`Consultando balance de ${address}...`, 'info');
                const balance = await contract.methods.getBalance(address).call();
                const balanceEth = web3.utils.fromWei(balance, 'ether');
                document.getElementById('balanceResult').textContent = `${parseFloat(balanceEth).toFixed(6)} ETH`;
                log(`Balance: ${balanceEth} ETH`, 'success');
            } catch (error) {
                log('Error: ' + error.message, 'error');
                document.getElementById('balanceResult').textContent = 'Error';
            }
        }

        async function testDeposit() {
            if (!contract || !userAddress) {
                alert('Conecta wallet y carga contrato');
                return;
            }

            const amount = document.getElementById('depositAmount').value;
            if (!amount || amount <= 0) {
                alert('Monto inválido');
                return;
            }

            try {
                const amountWei = web3.utils.toWei(amount.toString(), 'ether');
                log(`Depositando ${amount} ETH...`, 'info');
                const tx = await contract.methods.deposit().send({
                    from: userAddress,
                    value: amountWei,
                    gas: 200000
                });
                document.getElementById('depositResult').innerHTML = 
                    `✅ Depositado! TX: <a href="https://sepolia.arbiscan.io/tx/${tx.transactionHash}" target="_blank" class="text-blue-400 underline">${tx.transactionHash.substring(0, 10)}...</a>`;
                log(`Depósito exitoso: ${tx.transactionHash}`, 'success');
                await testGetBalance(); // Actualizar balance
            } catch (error) {
                log('Error: ' + error.message, 'error');
                document.getElementById('depositResult').textContent = 'Error: ' + error.message;
            }
        }

        async function testSendPayment() {
            if (!contract || !userAddress) {
                alert('Conecta wallet y carga contrato');
                return;
            }

            const to = document.getElementById('paymentTo').value.trim();
            const amount = document.getElementById('paymentAmount').value;

            if (!to || !to.startsWith('0x') || to.length !== 42) {
                alert('Dirección destino inválida');
                return;
            }

            if (!amount || amount <= 0) {
                alert('Monto inválido');
                return;
            }

            try {
                const amountWei = web3.utils.toWei(amount.toString(), 'ether');
                log(`Enviando ${amount} ETH a ${to}...`, 'info');
                const tx = await contract.methods.sendPayment(to, amountWei).send({
                    from: userAddress,
                    gas: 300000
                });
                document.getElementById('paymentResult').innerHTML = 
                    `✅ Pago enviado! TX: <a href="https://sepolia.arbiscan.io/tx/${tx.transactionHash}" target="_blank" class="text-blue-400 underline">${tx.transactionHash.substring(0, 10)}...</a>`;
                log(`Pago exitoso: ${tx.transactionHash}`, 'success');
                await testGetBalance(); // Actualizar balance
            } catch (error) {
                log('Error: ' + error.message, 'error');
                document.getElementById('paymentResult').textContent = 'Error: ' + error.message;
            }
        }

        async function testWithdraw() {
            if (!contract || !userAddress) {
                alert('Conecta wallet y carga contrato');
                return;
            }

            const amount = document.getElementById('withdrawAmount').value;
            if (!amount || amount <= 0) {
                alert('Monto inválido');
                return;
            }

            try {
                const amountWei = web3.utils.toWei(amount.toString(), 'ether');
                log(`Retirando ${amount} ETH...`, 'info');
                const tx = await contract.methods.withdraw(amountWei).send({
                    from: userAddress,
                    gas: 300000
                });
                document.getElementById('withdrawResult').innerHTML = 
                    `✅ Retirado! TX: <a href="https://sepolia.arbiscan.io/tx/${tx.transactionHash}" target="_blank" class="text-blue-400 underline">${tx.transactionHash.substring(0, 10)}...</a>`;
                log(`Retiro exitoso: ${tx.transactionHash}`, 'success');
                await testGetBalance(); // Actualizar balance
            } catch (error) {
                log('Error: ' + error.message, 'error');
                document.getElementById('withdrawResult').textContent = 'Error: ' + error.message;
            }
        }

        // Event listeners
        document.getElementById('connectBtn').addEventListener('click', connectWallet);
        document.getElementById('loadContractBtn').addEventListener('click', loadContract);
        document.getElementById('getBalanceBtn').addEventListener('click', testGetBalance);
        document.getElementById('depositBtn').addEventListener('click', testDeposit);
        document.getElementById('sendPaymentBtn').addEventListener('click', testSendPayment);
        document.getElementById('withdrawBtn').addEventListener('click', testWithdraw);

        // Auto-conectar si ya está conectado
        window.addEventListener('load', async () => {
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        await connectWallet();
                    }
                } catch (error) {
                    console.error('Error al verificar conexión:', error);
                }
            }
        });
    </script>
</body>
</html>



